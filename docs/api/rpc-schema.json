{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "cdev JSON-RPC API Schema",
  "version": "1.2.0",
  "methods": {
    "agent/run": {
      "description": "Start an AI agent with a prompt",
      "params": {
        "type": "object",
        "properties": {
          "prompt": { "type": "string", "description": "The prompt to send" },
          "mode": { "type": "string", "enum": ["new", "continue"], "default": "new" },
          "session_id": { "type": "string", "description": "Required if mode is 'continue'" },
          "agent_type": { "type": "string", "enum": ["claude", "gemini", "codex"], "default": "claude" }
        },
        "required": ["prompt"]
      },
      "result": {
        "type": "object",
        "properties": {
          "status": { "type": "string" },
          "session_id": { "type": "string" },
          "agent_type": { "type": "string" }
        }
      }
    },
    "agent/stop": {
      "description": "Stop the running agent",
      "params": null,
      "result": {
        "type": "object",
        "properties": {
          "status": { "type": "string" }
        }
      }
    },
    "agent/respond": {
      "description": "Send a response to an agent's tool use request",
      "params": {
        "type": "object",
        "properties": {
          "tool_use_id": { "type": "string" },
          "response": { "type": "string" },
          "is_error": { "type": "boolean", "default": false }
        },
        "required": ["tool_use_id", "response"]
      },
      "result": {
        "type": "object",
        "properties": {
          "status": { "type": "string" }
        }
      }
    },
    "status/get": {
      "description": "Get current server status",
      "params": null,
      "result": {
        "type": "object",
        "properties": {
          "session_id": { "type": "string" },
          "agent_session_id": { "type": "string" },
          "agent_state": { "type": "string", "enum": ["idle", "starting", "running", "stopping"] },
          "agent_type": { "type": "string" },
          "connected_clients": { "type": "integer" },
          "repo_path": { "type": "string" },
          "repo_name": { "type": "string" },
          "uptime_seconds": { "type": "integer" },
          "version": { "type": "string" },
          "watcher_enabled": { "type": "boolean" },
          "git_enabled": { "type": "boolean" }
        }
      }
    },
    "git/status": {
      "description": "Get git repository status (matches HTTP API format)",
      "params": null,
      "result": {
        "type": "object",
        "properties": {
          "branch": { "type": "string" },
          "upstream": { "type": "string" },
          "ahead": { "type": "integer" },
          "behind": { "type": "integer" },
          "staged": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "path": { "type": "string" },
                "status": { "type": "string" }
              }
            }
          },
          "unstaged": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "path": { "type": "string" },
                "status": { "type": "string" }
              }
            }
          },
          "untracked": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "path": { "type": "string" },
                "status": { "type": "string" }
              }
            }
          },
          "conflicted": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "path": { "type": "string" },
                "status": { "type": "string" }
              }
            }
          },
          "repo_name": { "type": "string" },
          "repo_root": { "type": "string" }
        }
      }
    },
    "git/diff": {
      "description": "Get diff for a file or all files",
      "params": {
        "type": "object",
        "properties": {
          "path": { "type": "string", "description": "File path (optional, omit for all files)" }
        }
      },
      "result": {
        "type": "object",
        "properties": {
          "path": { "type": "string" },
          "diff": { "type": "string" },
          "is_staged": { "type": "boolean" },
          "is_new": { "type": "boolean" }
        }
      }
    },
    "git/stage": {
      "description": "Stage files for commit (matches HTTP API format)",
      "params": {
        "type": "object",
        "properties": {
          "paths": { "type": "array", "items": { "type": "string" } }
        },
        "required": ["paths"]
      },
      "result": {
        "type": "object",
        "properties": {
          "success": { "type": "boolean" },
          "staged": { "type": "array", "items": { "type": "string" } }
        }
      }
    },
    "git/unstage": {
      "description": "Unstage files from the staging area (matches HTTP API format)",
      "params": {
        "type": "object",
        "properties": {
          "paths": { "type": "array", "items": { "type": "string" } }
        },
        "required": ["paths"]
      },
      "result": {
        "type": "object",
        "properties": {
          "success": { "type": "boolean" },
          "unstaged": { "type": "array", "items": { "type": "string" } }
        }
      }
    },
    "git/discard": {
      "description": "Discard unstaged changes to files (matches HTTP API format)",
      "params": {
        "type": "object",
        "properties": {
          "paths": { "type": "array", "items": { "type": "string" } }
        },
        "required": ["paths"]
      },
      "result": {
        "type": "object",
        "properties": {
          "success": { "type": "boolean" },
          "discarded": { "type": "array", "items": { "type": "string" } }
        }
      }
    },
    "git/commit": {
      "description": "Create a commit with staged changes (matches HTTP API format)",
      "params": {
        "type": "object",
        "properties": {
          "message": { "type": "string" },
          "push": { "type": "boolean", "default": false }
        },
        "required": ["message"]
      },
      "result": {
        "type": "object",
        "properties": {
          "success": { "type": "boolean" },
          "sha": { "type": "string" },
          "message": { "type": "string" },
          "files_committed": { "type": "integer" },
          "pushed": { "type": "boolean" },
          "error": { "type": "string" }
        }
      }
    },
    "git/push": {
      "description": "Push commits to remote repository (matches HTTP API format)",
      "params": null,
      "result": {
        "type": "object",
        "properties": {
          "success": { "type": "boolean" },
          "message": { "type": "string" },
          "commits_pushed": { "type": "integer" },
          "error": { "type": "string" }
        }
      }
    },
    "git/pull": {
      "description": "Pull changes from remote repository (matches HTTP API format)",
      "params": null,
      "result": {
        "type": "object",
        "properties": {
          "success": { "type": "boolean" },
          "message": { "type": "string" },
          "commits_pulled": { "type": "integer" },
          "files_changed": { "type": "integer" },
          "conflicted_files": { "type": "array", "items": { "type": "string" } },
          "error": { "type": "string" }
        }
      }
    },
    "git/branches": {
      "description": "List all git branches (matches HTTP API format)",
      "params": null,
      "result": {
        "type": "object",
        "properties": {
          "current": { "type": "string" },
          "upstream": { "type": "string" },
          "ahead": { "type": "integer" },
          "behind": { "type": "integer" },
          "branches": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "name": { "type": "string" },
                "current": { "type": "boolean" }
              }
            }
          }
        }
      }
    },
    "git/checkout": {
      "description": "Checkout a branch (matches HTTP API format)",
      "params": {
        "type": "object",
        "properties": {
          "branch": { "type": "string" },
          "create": { "type": "boolean", "default": false }
        },
        "required": ["branch"]
      },
      "result": {
        "type": "object",
        "properties": {
          "success": { "type": "boolean" },
          "branch": { "type": "string" },
          "message": { "type": "string" },
          "error": { "type": "string" }
        }
      }
    },
    "file/get": {
      "description": "Get file content",
      "params": {
        "type": "object",
        "properties": {
          "path": { "type": "string" }
        },
        "required": ["path"]
      },
      "result": {
        "type": "object",
        "properties": {
          "path": { "type": "string" },
          "content": { "type": "string" },
          "encoding": { "type": "string" },
          "size": { "type": "integer" },
          "truncated": { "type": "boolean" }
        }
      }
    },
    "file/list": {
      "description": "List directory contents",
      "params": {
        "type": "object",
        "properties": {
          "path": { "type": "string", "description": "Relative path from repo root (empty for root)" }
        }
      },
      "result": {
        "type": "object",
        "properties": {
          "path": { "type": "string" },
          "entries": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "name": { "type": "string" },
                "type": { "type": "string", "enum": ["file", "directory"] },
                "size": { "type": "integer" },
                "modified": { "type": "string", "format": "date-time" },
                "children_count": { "type": "integer" }
              }
            }
          },
          "total_count": { "type": "integer" }
        }
      }
    },
    "session/list": {
      "description": "List available sessions from all configured AI agents",
      "params": {
        "type": "object",
        "properties": {
          "agent_type": { "type": "string", "description": "Filter by agent type" },
          "limit": { "type": "integer", "default": 50 }
        }
      },
      "result": {
        "type": "object",
        "properties": {
          "sessions": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "session_id": { "type": "string" },
                "agent_type": { "type": "string" },
                "summary": { "type": "string" },
                "message_count": { "type": "integer" },
                "start_time": { "type": "string", "format": "date-time" },
                "last_updated": { "type": "string", "format": "date-time" }
              }
            }
          },
          "total": { "type": "integer" }
        }
      }
    },
    "session/get": {
      "description": "Get detailed information about a specific session",
      "params": {
        "type": "object",
        "properties": {
          "session_id": { "type": "string" },
          "agent_type": { "type": "string" }
        },
        "required": ["session_id"]
      },
      "result": {
        "type": "object",
        "properties": {
          "session_id": { "type": "string" },
          "agent_type": { "type": "string" },
          "summary": { "type": "string" },
          "message_count": { "type": "integer" },
          "start_time": { "type": "string", "format": "date-time" },
          "last_updated": { "type": "string", "format": "date-time" },
          "branch": { "type": "string" },
          "project_path": { "type": "string" }
        }
      }
    },
    "session/messages": {
      "description": "Get paginated messages for a session (matches HTTP API format)",
      "params": {
        "type": "object",
        "properties": {
          "session_id": { "type": "string" },
          "agent_type": { "type": "string" },
          "limit": { "type": "integer", "default": 50, "maximum": 500 },
          "offset": { "type": "integer", "default": 0 },
          "order": { "type": "string", "enum": ["asc", "desc"], "default": "asc" }
        },
        "required": ["session_id"]
      },
      "result": {
        "type": "object",
        "properties": {
          "session_id": { "type": "string" },
          "messages": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "id": { "type": "integer", "description": "Database row ID" },
                "session_id": { "type": "string" },
                "type": { "type": "string", "enum": ["user", "assistant"] },
                "uuid": { "type": "string" },
                "timestamp": { "type": "string", "format": "date-time" },
                "git_branch": { "type": "string" },
                "message": {
                  "type": "object",
                  "description": "Raw Claude API message (content, role, model, usage, etc)"
                },
                "is_context_compaction": { "type": "boolean" }
              }
            }
          },
          "total": { "type": "integer" },
          "limit": { "type": "integer" },
          "offset": { "type": "integer" },
          "has_more": { "type": "boolean" },
          "query_time_ms": { "type": "number" }
        }
      }
    },
    "session/elements": {
      "description": "Get pre-parsed UI elements for a session",
      "params": {
        "type": "object",
        "properties": {
          "session_id": { "type": "string" },
          "agent_type": { "type": "string" },
          "limit": { "type": "integer", "default": 50, "maximum": 100 },
          "before": { "type": "string", "description": "Return elements before this ID" },
          "after": { "type": "string", "description": "Return elements after this ID" }
        },
        "required": ["session_id"]
      },
      "result": {
        "type": "object",
        "properties": {
          "session_id": { "type": "string" },
          "elements": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "id": { "type": "string" },
                "type": { "type": "string", "enum": ["user_input", "assistant_text", "tool_call", "tool_result", "diff", "thinking"] },
                "timestamp": { "type": "string", "format": "date-time" },
                "content": { "type": "object" }
              }
            }
          },
          "pagination": {
            "type": "object",
            "properties": {
              "total": { "type": "integer" },
              "returned": { "type": "integer" },
              "has_more_before": { "type": "boolean" },
              "has_more_after": { "type": "boolean" },
              "oldest_id": { "type": "string" },
              "newest_id": { "type": "string" }
            }
          }
        }
      }
    },
    "session/delete": {
      "description": "Delete a specific session or all sessions",
      "params": {
        "type": "object",
        "properties": {
          "session_id": { "type": "string", "description": "Session ID to delete (omit for all)" },
          "agent_type": { "type": "string" }
        }
      },
      "result": {
        "type": "object",
        "properties": {
          "status": { "type": "string" },
          "session_id": { "type": "string" },
          "deleted": { "type": "integer" }
        }
      }
    },
    "session/watch": {
      "description": "Start watching a session for real-time updates",
      "params": {
        "type": "object",
        "properties": {
          "session_id": { "type": "string" }
        },
        "required": ["session_id"]
      },
      "result": {
        "type": "object",
        "properties": {
          "status": { "type": "string" },
          "watching": { "type": "boolean" }
        }
      }
    },
    "session/unwatch": {
      "description": "Stop watching the current session",
      "params": null,
      "result": {
        "type": "object",
        "properties": {
          "status": { "type": "string" },
          "watching": { "type": "boolean" }
        }
      }
    },
    "initialize": {
      "description": "Initialize the connection and negotiate capabilities",
      "params": {
        "type": "object",
        "properties": {
          "protocol_version": { "type": "string" },
          "client_info": {
            "type": "object",
            "properties": {
              "name": { "type": "string" },
              "version": { "type": "string" }
            }
          },
          "capabilities": { "type": "object" }
        }
      },
      "result": {
        "type": "object",
        "properties": {
          "protocol_version": { "type": "string" },
          "server_info": {
            "type": "object",
            "properties": {
              "name": { "type": "string" },
              "version": { "type": "string" }
            }
          },
          "capabilities": {
            "type": "object",
            "properties": {
              "agents": { "type": "array", "items": { "type": "string" } },
              "features": { "type": "array", "items": { "type": "string" } }
            }
          }
        }
      }
    },
    "initialized": {
      "description": "Notification that client initialization is complete",
      "params": null,
      "result": null
    },
    "shutdown": {
      "description": "Request the server to shut down gracefully",
      "params": null,
      "result": {
        "type": "object",
        "properties": {
          "success": { "type": "boolean" }
        }
      }
    }
  },
  "notifications": {
    "event/heartbeat": {
      "description": "Periodic heartbeat",
      "params": {
        "type": "object",
        "properties": {
          "server_time": { "type": "string", "format": "date-time" },
          "sequence": { "type": "integer" },
          "agent_status": { "type": "string" },
          "uptime_seconds": { "type": "integer" }
        }
      }
    },
    "event/agent_started": {
      "description": "Agent has started",
      "params": {
        "type": "object",
        "properties": {
          "session_id": { "type": "string" },
          "agent_type": { "type": "string" },
          "prompt": { "type": "string" }
        }
      }
    },
    "event/agent_output": {
      "description": "Agent output",
      "params": {
        "type": "object",
        "properties": {
          "type": { "type": "string", "enum": ["text", "tool_use", "tool_result", "thinking"] },
          "content": { "type": "string" },
          "tool_name": { "type": "string" },
          "tool_id": { "type": "string" },
          "tool_input": { "type": "object" }
        }
      }
    },
    "event/agent_stopped": {
      "description": "Agent has stopped",
      "params": {
        "type": "object",
        "properties": {
          "session_id": { "type": "string" },
          "reason": { "type": "string", "enum": ["completed", "stopped", "error"] }
        }
      }
    },
    "event/file_changed": {
      "description": "File change detected",
      "params": {
        "type": "object",
        "properties": {
          "path": { "type": "string" },
          "change": { "type": "string", "enum": ["created", "modified", "deleted", "renamed"] }
        }
      }
    },
    "event/git_status_changed": {
      "description": "Git status changed",
      "params": {
        "type": "object",
        "properties": {
          "branch": { "type": "string" },
          "staged": { "type": "array", "items": { "type": "string" } },
          "unstaged": { "type": "array", "items": { "type": "string" } },
          "untracked": { "type": "array", "items": { "type": "string" } }
        }
      }
    }
  },
  "errors": {
    "-32700": { "name": "ParseError", "message": "Invalid JSON" },
    "-32600": { "name": "InvalidRequest", "message": "Not a valid JSON-RPC request" },
    "-32601": { "name": "MethodNotFound", "message": "Method does not exist" },
    "-32602": { "name": "InvalidParams", "message": "Invalid method parameters" },
    "-32603": { "name": "InternalError", "message": "Internal server error" },
    "-32001": { "name": "AgentAlreadyRunning", "message": "An agent is already running" },
    "-32002": { "name": "AgentNotRunning", "message": "No agent is currently running" },
    "-32003": { "name": "AgentError", "message": "Agent execution error" },
    "-32004": { "name": "AgentNotConfigured", "message": "Agent type not configured" },
    "-32010": { "name": "FileNotFound", "message": "Requested file not found" },
    "-32011": { "name": "GitError", "message": "Git operation failed" },
    "-32012": { "name": "SessionNotFound", "message": "Session not found" }
  }
}
